name: Deploy QA (OlmeraOT)

on:
  push:
    branches: [ develop ]
  workflow_dispatch:

concurrency:
  group: deploy-qa-olmeraot
  cancel-in-progress: false

env:
  # Lee las URLs fijas desde Repository Variables (Settings → Variables → Actions)
  CORE_ZIP_URL_QA: ${{ vars.CORE_ZIP_URL_QA }}
  CORE_SHA_URL_QA: ${{ vars.CORE_SHA_URL_QA }}

jobs:
  deploy:
    name: Deploy to QA (VPS)
    runs-on: ubuntu-latest

    steps:
      - name: (Opcional) Establecer known_hosts
        run: |
          mkdir -p ~/.ssh
          if [ -n "${{ secrets.SSH_KNOWN_HOSTS }}" ]; then
            echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
            chmod 644 ~/.ssh/known_hosts
          else
            echo "No SSH_KNOWN_HOSTS provided; skipping."
          fi

      - name: SSH into VPS and deploy develop
        uses: appleboy/ssh-action@v1.2.0
        env:
          CORE_ZIP_URL_QA: ${{ env.CORE_ZIP_URL_QA }}
          CORE_SHA_URL_QA: ${{ env.CORE_SHA_URL_QA }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: CORE_ZIP_URL_QA,CORE_SHA_URL_QA
          script_stop: true
          script: |
            set -euo pipefail

            echo "[QA] Deploy en ${{ secrets.VPS_QA_PATH }}"
            cd "${{ secrets.VPS_QA_PATH }}"

            echo "[QA] Sync código (develop + submodules)"
            git fetch --all --prune
            git checkout develop
            git reset --hard origin/develop
            git submodule sync --recursive
            git submodule update --init --recursive --remote

            echo "[QA] Render config"
            /usr/local/bin/olmera-render-config qa

            BIN_DIR="/opt/olmeraot/qa/bin"
            BIN_PATH="${BIN_DIR}/olmeraot"
            SHA_MARKER="${BIN_DIR}/OLMERAOT_ZIP_SHA"

            mkdir -p "${BIN_DIR}"

            echo "[QA] Descargando SHA remoto"
            curl -fsSL -o /tmp/SHA256SUMS "$CORE_SHA_URL_QA"

            REMOTE_SHA="$(awk '{print $1}' /tmp/SHA256SUMS)"
            LOCAL_SHA="$(cat "${SHA_MARKER}" 2>/dev/null || true)"

            if [ -n "${LOCAL_SHA}" ] && [ "${LOCAL_SHA}" = "${REMOTE_SHA}" ] && [ -x "${BIN_PATH}" ]; then
              echo "[QA] Binario ya actualizado (SHA coincide). No se descarga ZIP."
            else
              echo "[QA] Descargando ZIP nuevo"
              curl -fsSL -o /tmp/olmeraot.zip "$CORE_ZIP_URL_QA"

              echo "[QA] Verificando ZIP con SHA256SUMS"
              pushd /tmp >/dev/null
              sha256sum --ignore-missing -c /tmp/SHA256SUMS
              popd >/dev/null

              echo "[QA] Descomprimiendo ZIP al bin dir"
              unzip -o /tmp/olmeraot.zip -d "${BIN_DIR}"
              chmod +x "${BIN_PATH}"
              echo "${REMOTE_SHA}" > "${SHA_MARKER}"
            fi

            echo "[QA] Reiniciando servicio (QA sí reinicia)"
            sudo systemctl restart olmeraot-qa.service
            systemctl --no-pager --lines=5 status olmeraot-qa.service || true
            tail -n 120 /var/log/olmeraot/qa.log || true
