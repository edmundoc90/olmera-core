name: CI/CD Pipeline

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches:
      - develop
      - main

env:
  CMAKE_BUILD_PARALLEL_LEVEL: 2
  MAKEFLAGS: "-j 2"

permissions:
  contents: write

jobs:
  # ============================================================================
  # STAGE 1: Detecci√≥n de cambios
  # ============================================================================
  changes:
    name: "Stage 1: Detect Changes"
    runs-on: ubuntu-latest
    outputs:
      cpp: ${{ steps.filter.outputs.cpp }}
      scripts: ${{ steps.filter.outputs.scripts }}
      overrides: ${{ steps.filter.outputs.overrides }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 2
          token: ${{ secrets.GH_PAT || github.token }}
      
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            cpp:
              - 'src/**'
              - 'tests/**/*.cpp'
              - 'cmake/**'
              - 'CMakeLists.txt'
              - 'vcpkg.json'
            scripts:
              - 'data/**/*.lua'
              - 'data/**/*.xml'
              - 'data-canary/**/*.lua'
              - 'data-canary/**/*.xml'
            overrides:
              - 'overrides'
              - 'overrides/**'

  # ============================================================================
  # STAGE 2: Build & Test
  # ============================================================================
  build:
    name: "Stage 2: Build & Test"
    needs: changes
    if: needs.changes.outputs.cpp == 'true' && (github.event_name == 'push' || !github.event.pull_request.draft)
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        buildtype: [linux-release]
    outputs:
      artifact_name: ${{ steps.artifact.outputs.name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Optimize apt performance
        run: |
          # Use Azure mirrors (faster for GitHub Actions runners)
          sudo sed -i 's|http://archive.ubuntu.com|http://azure.archive.ubuntu.com|g' /etc/apt/sources.list
          sudo sed -i 's|http://security.ubuntu.com|http://azure.archive.ubuntu.com|g' /etc/apt/sources.list
          # Enable parallel downloads
          echo 'Acquire::Queue-Mode "host";' | sudo tee /etc/apt/apt.conf.d/99parallel
          echo 'Acquire::http::Pipeline-Depth "5";' | sudo tee -a /etc/apt/apt.conf.d/99parallel

      - name: Install Linux Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ccache linux-headers-"$(uname -r)"

      - name: Switch to gcc-13
        run: |
          sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
          sudo apt-get update
          sudo apt-get install -y gcc-13 g++-13
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100 \
            --slave /usr/bin/g++ g++ /usr/bin/g++-13 \
            --slave /usr/bin/gcov gcov /usr/bin/gcov-12
          sudo update-alternatives --set gcc /usr/bin/gcc-13

      - name: CCache
        uses: hendrikmuhs/ccache-action@main
        with:
          max-size: "1G"
          key: ccache-ubuntu-22.04-${{ matrix.buildtype }}
          restore-keys: |
            ccache-ubuntu-22.04

      - name: Restore artifacts and install vcpkg
        run: |
          vcpkgCommitId=$(grep '.builtin-baseline' vcpkg.json | awk -F: '{print $2}' | tr -d '," ')
          echo "VCPKG_GIT_COMMIT_ID=$vcpkgCommitId" >> "$GITHUB_ENV"

      - name: Get vcpkg
        uses: lukka/run-vcpkg@main
        with:
          vcpkgGitURL: "https://github.com/microsoft/vcpkg.git"
          vcpkgGitCommitId: ${{ env.VCPKG_GIT_COMMIT_ID }}
          
      - name: Setup vcpkg binary caching
        run: |
          mkdir -p $HOME/.cache/vcpkg/archives
          echo "VCPKG_BINARY_SOURCES=clear;x-gha,readwrite" >> "$GITHUB_ENV"

      - name: Get latest CMake and ninja
        uses: lukka/get-cmake@main

      - name: Run CMake
        uses: lukka/run-cmake@main
        with:
          configurePresetAdditionalArgs: "['-DTOGGLE_BIN_FOLDER=ON']"
          configurePreset: ${{ matrix.buildtype }}
          buildPreset: ${{ matrix.buildtype }}

      - name: Run Unit Tests
        run: ctest -V -R unit

      - name: Run Integration Tests
        run: ctest -V -R integration

      # Solo empaquetar para linux-release
      - name: Package binary
        if: matrix.buildtype == 'linux-release'
        run: |
          mkdir -p dist
          cp build/linux-release/bin/olmeraot dist/olmeraot
          cd dist
          zip -r olmeraot-linux-x86_64.zip olmeraot
          sha256sum olmeraot-linux-x86_64.zip > SHA256SUMS
          ls -lh

      - name: Set artifact name
        if: matrix.buildtype == 'linux-release'
        id: artifact
        run: echo "name=olmeraot-build-${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Upload artifact
        if: matrix.buildtype == 'linux-release'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact.outputs.name }}
          path: dist/
          retention-days: 30

  # ============================================================================
  # STAGE 2B: Build Debug (manual approval required)
  # ============================================================================
  build-debug:
    name: "Stage 2B: Build Debug (Manual)"
    needs: changes
    if: needs.changes.outputs.cpp == 'true'
    runs-on: ubuntu-22.04
    environment:
      name: debug-build
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Optimize apt performance
        run: |
          # Use Azure mirrors (faster for GitHub Actions runners)
          sudo sed -i 's|http://archive.ubuntu.com|http://azure.archive.ubuntu.com|g' /etc/apt/sources.list
          sudo sed -i 's|http://security.ubuntu.com|http://azure.archive.ubuntu.com|g' /etc/apt/sources.list
          # Enable parallel downloads
          echo 'Acquire::Queue-Mode "host";' | sudo tee /etc/apt/apt.conf.d/99parallel
          echo 'Acquire::http::Pipeline-Depth "5";' | sudo tee -a /etc/apt/apt.conf.d/99parallel

      - name: Install Linux Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ccache linux-headers-"$(uname -r)"

      - name: Switch to gcc-13
        run: |
          sudo add-apt-repository -y ppa:ubuntu-toolchain-r/test
          sudo apt-get update
          sudo apt-get install -y gcc-13 g++-13
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-13 100 \
            --slave /usr/bin/g++ g++ /usr/bin/g++-13 \
            --slave /usr/bin/gcov gcov /usr/bin/gcov-12
          sudo update-alternatives --set gcc /usr/bin/gcc-13

      - name: CCache
        uses: hendrikmuhs/ccache-action@main
        with:
          max-size: "1G"
          key: ccache-ubuntu-22.04-linux-debug
          restore-keys: |
            ccache-ubuntu-22.04

      - name: Restore artifacts and install vcpkg
        run: |
          vcpkgCommitId=$(grep '.builtin-baseline' vcpkg.json | awk -F: '{print $2}' | tr -d '," ')
          echo "VCPKG_GIT_COMMIT_ID=$vcpkgCommitId" >> "$GITHUB_ENV"

      - name: Get vcpkg
        uses: lukka/run-vcpkg@main
        with:
          vcpkgGitURL: "https://github.com/microsoft/vcpkg.git"
          vcpkgGitCommitId: ${{ env.VCPKG_GIT_COMMIT_ID }}
          
      - name: Setup vcpkg binary caching
        run: |
          mkdir -p $HOME/.cache/vcpkg/archives
          echo "VCPKG_BINARY_SOURCES=clear;x-gha,readwrite" >> "$GITHUB_ENV"

      - name: Get latest CMake and ninja
        uses: lukka/get-cmake@main

      - name: Run CMake
        uses: lukka/run-cmake@main
        with:
          configurePresetAdditionalArgs: "['-DTOGGLE_BIN_FOLDER=ON']"
          configurePreset: linux-debug
          buildPreset: linux-debug

      - name: Run Unit Tests
        run: ctest -V -R unit

      - name: Run Integration Tests
        run: ctest -V -R integration

      - name: Package debug binary
        run: |
          mkdir -p dist
          cp build/linux-debug/bin/olmeraot dist/olmeraot-debug
          cd dist
          zip -r olmeraot-linux-x86_64-debug.zip olmeraot-debug
          sha256sum olmeraot-linux-x86_64-debug.zip > SHA256SUMS-debug
          ls -lh

      - name: Upload debug artifact
        uses: actions/upload-artifact@v4
        with:
          name: olmeraot-debug-${{ github.sha }}
          path: dist/
          retention-days: 7

  # ============================================================================
  # STAGE 3A: Sync Scripts to QA (solo scripts, sin build)
  # ============================================================================
  sync-scripts-qa:
    name: "Stage 3A: Sync Scripts to QA"
    needs: changes
    if: |
      github.ref == 'refs/heads/develop' &&
      (needs.changes.outputs.scripts == 'true' || needs.changes.outputs.overrides == 'true') &&
      needs.changes.outputs.cpp != 'true'
    runs-on: ubuntu-latest
    env:
      QA_DEPLOY_ENABLED: ${{ vars.QA_DEPLOY_ENABLED || secrets.QA_DEPLOY_ENABLED }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GH_PAT || github.token }}

      - name: Prepare SSH known_hosts (QA)
        if: env.QA_DEPLOY_ENABLED == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          if [ -n "${{ secrets.SSH_KNOWN_HOSTS }}" ]; then
            printf '%s\n' "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true
          fi
          chmod 644 ~/.ssh/known_hosts

      - name: Upload scripts to QA (tar + SSH)
        if: env.QA_DEPLOY_ENABLED == 'true'
        run: |
          set -euo pipefail
          
          # Crear tarball con prefijo current/ usando transform
          tar czf /tmp/scripts.tar.gz \
            --transform 's,^,current/,' \
            data data-canary data-otservbr-global overrides key.pem
          
          # Configurar SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Copiar tarball
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            /tmp/scripts.tar.gz \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/
          
          # Limpiar carpetas que vamos a reemplazar y extraer
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd ${{ secrets.VPS_QA_PATH }} && \
             rm -rf current/data current/data-canary current/data-otservbr-global current/overrides && \
             tar xzf /tmp/scripts.tar.gz && \
             rm /tmp/scripts.tar.gz"
          
          rm -f ~/.ssh/deploy_key /tmp/scripts.tar.gz

      - name: Reload QA server (SIGHUP)
        if: env.QA_DEPLOY_ENABLED == 'true'
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            # Hot-reload scripts (SIGHUP) en lugar de restart completo
            if command -v systemctl >/dev/null 2>&1; then
              echo "Sending SIGHUP to reload scripts..."
              sudo systemctl kill -s HUP olmeraot-qa.service || true
            else
              pid=$(pidof olmeraot || true)
              [ -n "$pid" ] && kill -HUP "$pid" || true
            fi
            
            echo "‚úÖ Scripts synced and reloaded without server restart"

      - name: Comment on commit
        if: env.QA_DEPLOY_ENABLED == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const changes = [];
            if ('${{ needs.changes.outputs.scripts }}' === 'true') changes.push('scripts');
            if ('${{ needs.changes.outputs.overrides }}' === 'true') changes.push('overrides');
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `‚úÖ Synced ${changes.join(' + ')} to QA without recompiling/restarting server`
            });

  # ============================================================================
  # STAGE 4A: Approve and Merge to Main (despu√©s de QA exitoso)
  # ============================================================================
  approve-merge-to-main:
    name: "Stage 4A: Approve Merge to Main"
    needs: [changes, sync-scripts-qa, deploy-qa]
    if: |
      github.ref == 'refs/heads/develop' &&
      !cancelled() &&
      (needs.sync-scripts-qa.result == 'success' || needs.deploy-qa.result == 'success')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    environment:
      name: approve-production
      url: https://github.com/${{ github.repository }}/compare/main...develop
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT || github.token }}

      - name: Create or update PR develop ‚Üí main
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const base = 'main';
            const head = `${owner}:develop`;
            // Find existing open PR
            const { data: prs } = await github.rest.pulls.list({ owner, repo, state: 'open', base, head });
            let pr = prs[0];
            if (!pr) {
              pr = (await github.rest.pulls.create({ owner, repo, base, head: 'develop', title: 'Promote develop to main', body: 'Auto-created after QA approval' })).data;
            }
            core.setOutput('number', pr.number.toString());
            core.setOutput('node_id', pr.node_id);
            core.setOutput('html_url', pr.html_url);

      - name: Request review from maintainer
        if: steps.pr.outputs.number
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const number = Number('${{ steps.pr.outputs.number }}');
            try {
              await github.rest.pulls.requestReviewers({ owner, repo, pull_number: number, reviewers: ['edmundoc90'] });
              core.info('‚úÖ Requested review from edmundoc90');
            } catch (e) {
              core.warning(`Could not request reviewer: ${e.message}`);
            }

      - name: Add label to PR
        if: steps.pr.outputs.number
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const number = Number('${{ steps.pr.outputs.number }}');
            try {
              await github.rest.issues.addLabels({ owner, repo, issue_number: number, labels: ['prod-promotion'] });
              core.info('üè∑Ô∏è  Label added to PR');
            } catch (e) {
              core.warning(`Could not add label: ${e.message}`);
            }

      - name: Enable auto-merge (squash) when checks pass
        if: steps.pr.outputs.node_id
        uses: actions/github-script@v7
        with:
          script: |
            const nodeId = '${{ steps.pr.outputs.node_id }}';
            const mutation = `mutation($pullRequestId: ID!) {\n  enablePullRequestAutoMerge(input: { pullRequestId: $pullRequestId, mergeMethod: SQUASH }) {\n    clientMutationId\n  }\n}`;
            try {
              await github.graphql(mutation, { pullRequestId: nodeId });
              core.info('‚úÖ Auto-merge enabled. The PR will merge when checks pass.');
            } catch (e) {
              core.warning(`Could not enable auto-merge: ${e.message}`);
            }

      - name: Add comment with PR link
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `‚úÖ PR creado: ${{ steps.pr.outputs.html_url }}. Se auto-mergear√° cuando los checks pasen (si auto-merge est√° habilitado en el repo).`
            });

  # ============================================================================
  # STAGE 3B: Deploy Binary to QA (con build)
  # ============================================================================
  deploy-qa:
    name: "Stage 3B: Deploy Binary to QA"
    needs: [changes, build]
    # Solo ejecuta si build realmente se ejecut√≥ exitosamente
    if: |
      github.ref == 'refs/heads/develop' &&
      needs.changes.outputs.cpp == 'true' &&
      needs.build.result == 'success'
    runs-on: ubuntu-latest
    # NOTA: Environment removido porque GitHub Actions fuerza la ejecuci√≥n del job
    # cuando existe un environment con deployment branches configuradas, ignorando
    # completamente las condiciones if. Esto es un comportamiento documentado de
    # GitHub Actions que no tiene soluci√≥n alternativa.
    env:
      QA_DEPLOY_ENABLED: ${{ vars.QA_DEPLOY_ENABLED || secrets.QA_DEPLOY_ENABLED }}
    # Ver: https://github.com/actions/runner/issues/2507
    # environment:
    #   name: qa-binary
    #   url: https://qa.olmeraot.com
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GH_PAT || github.token }}
      
      - name: Prepare SSH known_hosts (QA)
        if: env.QA_DEPLOY_ENABLED == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          if [ -n "${{ secrets.SSH_KNOWN_HOSTS }}" ]; then
            printf '%s\n' "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true
          fi
          chmod 644 ~/.ssh/known_hosts

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact_name }}
          path: dist/

      - name: Publish qa-latest release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: qa-latest
          name: QA Latest
          body: |
            üöÄ **QA Release**
            
            **Branch:** develop
            **Commit:** ${{ github.sha }}
            **Built at:** ${{ github.event.head_commit.timestamp }}
            
            **Changes:**
            - C++ Code: ${{ needs.changes.outputs.cpp == 'true' && '‚úÖ' || '‚ûñ' }}
            - Scripts: ${{ needs.changes.outputs.scripts == 'true' && '‚úÖ' || '‚ûñ' }}
            
            ---
            Auto-deployed to QA environment.
          draft: false
          prerelease: true
          files: |
            dist/olmeraot-linux-x86_64.zip
            dist/SHA256SUMS

      - name: Upload scripts to QA (tar + SSH)
        if: env.QA_DEPLOY_ENABLED == 'true'
        run: |
          set -euo pipefail
          
          # Crear tarball con prefijo current/ usando transform
          tar czf /tmp/scripts.tar.gz \
            --transform 's,^,current/,' \
            data data-canary data-otservbr-global overrides key.pem
          
          # Configurar SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Copiar tarball
          scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            /tmp/scripts.tar.gz \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/
          
          # Limpiar carpetas que vamos a reemplazar y extraer
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} \
            "cd ${{ secrets.VPS_QA_PATH }} && \
             rm -rf current/data current/data-canary current/data-otservbr-global current/overrides && \
             tar xzf /tmp/scripts.tar.gz && \
             rm /tmp/scripts.tar.gz"
          
          rm -f ~/.ssh/deploy_key /tmp/scripts.tar.gz

      - name: Deploy binary + restart QA Server
        if: env.QA_DEPLOY_ENABLED == 'true'
        uses: appleboy/ssh-action@v1.2.0
        with:
          # Mapped to existing repository secrets
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            DEST_PATH="${{ secrets.VPS_QA_PATH }}"
            DEST_PATH=${DEST_PATH:-/opt/olmeraot/qa}
            cd "$DEST_PATH"
            
            # Download latest QA release binary
            curl -fsSL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -o olmeraot.zip \
              "https://github.com/${{ github.repository }}/releases/download/qa-latest/olmeraot-linux-x86_64.zip"
            
            # Extract binary
            unzip -o olmeraot.zip
            chmod +x olmeraot
            
            # Create symlink for config.lua in current/
            ln -sf ../config.lua current/config.lua
            # Ensure key.pem present in current (fallback if not synced)
            if [ ! -f current/key.pem ] && [ -f key.pem ]; then
              cp -f key.pem current/key.pem
            fi
            chmod 640 current/key.pem || true
            
            # Restart server (binary changed)
            echo "Restarting QA server (binary updated)..."
            sudo systemctl restart olmeraot-qa || true
            
            # Health check
            sleep 3
            sudo systemctl status olmeraot-qa --no-pager || true

  # ============================================================================
  # STAGE 4: Deploy to Staging (requiere aprobaci√≥n manual)
  # ============================================================================
  deploy-staging:
    name: "Stage 4: Deploy to Staging"
    needs: [build, deploy-qa]
    # Solo ejecuta si build y deploy-qa tuvieron √©xito (no skipped)
    if: ${{ vars.STAGING_DEPLOY_ENABLED == 'true' && needs.build.result == 'success' && needs.deploy-qa.result == 'success' }}
    runs-on: ubuntu-latest
    environment:
      name: staging-server
      url: https://staging.olmeraot.com
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GH_PAT || github.token }}
      
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact_name }}
          path: dist/

      - name: Verify checksums
        run: |
          cd dist
          sha256sum -c SHA256SUMS

      - name: Prepare SSH known_hosts (Staging)
        if: vars.STAGING_DEPLOY_ENABLED == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          if [ -n "${{ secrets.SSH_KNOWN_HOSTS }}" ]; then
            printf '%s\n' "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true
          fi
          chmod 644 ~/.ssh/known_hosts

      - name: Upload scripts to Staging (scp)
        if: vars.STAGING_DEPLOY_ENABLED == 'true'
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "data,data-canary,overrides"
          target: /opt/olmeraot/staging/current/
          overwrite: true
          rm: false

      - name: Deploy to Staging Server (binary + restart)
        if: vars.STAGING_DEPLOY_ENABLED == 'true'
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            cd /opt/olmeraot/staging
            
            # Download from QA release
            curl -fsSL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -o olmeraot.zip \
              "https://github.com/${{ github.repository }}/releases/download/qa-latest/olmeraot-linux-x86_64.zip"
            
            unzip -o olmeraot.zip
            chmod +x olmeraot
            
            sudo systemctl restart olmeraot-staging || true


  # ============================================================================
  # STAGE 5B: Promote Binary to Production (solo en main, requiere aprobaci√≥n)
  # ============================================================================
  # ============================================================================
  # STAGE 5A: Sync Scripts to Production (scripts-only path)
  # ============================================================================
  sync-scripts-prod:
    name: "Stage 5A: Sync Scripts to Production"
    needs: [changes, approve-merge-to-main]
    if: |
      github.ref == 'refs/heads/main' &&
      (needs.changes.outputs.scripts == 'true' || needs.changes.outputs.overrides == 'true') &&
      needs.changes.outputs.cpp != 'true'
    runs-on: ubuntu-latest
    environment:
      name: production-server
      url: https://olmeraot.com
    env:
      PROD_DEPLOY_ENABLED: ${{ vars.PROD_DEPLOY_ENABLED || secrets.PROD_DEPLOY_ENABLED }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GH_PAT || github.token }}

      - name: Prepare SSH known_hosts (Prod)
        if: env.PROD_DEPLOY_ENABLED == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          if [ -n "${{ secrets.SSH_KNOWN_HOSTS }}" ]; then
            printf '%s\n' "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true
          fi
          chmod 644 ~/.ssh/known_hosts

      - name: Upload scripts to Production (tar + SSH)
        if: env.PROD_DEPLOY_ENABLED == 'true'
        run: |
          set -euo pipefail
          
          # Crear tarball con prefijo current/ usando transform
          tar czf /tmp/scripts.tar.gz \
            --transform 's,^,current/,' \
            data data-canary data-otservbr-global overrides key.pem
          
          # Transferir a producci√≥n
          scp -o StrictHostKeyChecking=yes \
            -i <(echo "${{ secrets.SSH_PRIVATE_KEY }}") \
            /tmp/scripts.tar.gz \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/

      - name: Extract and reload (SIGHUP)
        if: env.PROD_DEPLOY_ENABLED == 'true'
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            DEST_PATH="${{ secrets.VPS_PROD_PATH }}"
            DEST_PATH=${DEST_PATH:-/opt/olmeraot/prod}
            
            cd "$DEST_PATH"
            
            # Limpiar directorios actuales antes de extraer
            rm -rf current/data current/data-canary current/data-otservbr-global current/overrides
            
            # Extraer directamente en el path padre
            tar xzf /tmp/scripts.tar.gz
            
            # Create symlink for config.lua en current/
            ln -sf ../config.lua current/config.lua
            # Asegurar permisos de key.pem
            chmod 640 current/key.pem || true
            
            # Hot-reload con SIGHUP
            pkill -SIGHUP olmeraot || echo "Server not running or signal failed"
            
            echo "‚úÖ Scripts synced to production and server reloaded"

      - name: Comment on commit
        if: env.PROD_DEPLOY_ENABLED == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `‚úÖ Synced scripts/overrides to Production (scripts-only path)`
            });

  # ============================================================================
  # STAGE 5B/6: Promote Binary to Production (with scripts if mixed)
  # ============================================================================
  promote-production:
    name: "Stage 6: Promote Binary to Production"
    needs: [changes, build, deploy-qa]
    if: |
      github.ref == 'refs/heads/main' && 
      vars.PROD_DEPLOY_ENABLED == 'true' && 
      (needs.deploy-qa.result == 'success' || needs.deploy-qa.result == 'skipped') &&
      !cancelled()
    runs-on: ubuntu-latest
    environment:
      name: production-server
      url: https://olmeraot.com
    steps:
      - name: Checkout repository (for scripts packaging)
        uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GH_PAT || github.token }}

      - name: Upload scripts to Production (tar + SSH)
        if: needs.changes.outputs.scripts == 'true' || needs.changes.outputs.overrides == 'true'
        run: |
          set -euo pipefail
          # Crear tarball con prefijo current/ usando transform
          tar czf /tmp/scripts.tar.gz \
            --transform 's,^,current/,' \
            data data-canary data-otservbr-global overrides key.pem
          
          # Transferir a producci√≥n usando la clave del repo
          scp -o StrictHostKeyChecking=yes \
            -i <(echo "${{ secrets.SSH_PRIVATE_KEY }}") \
            /tmp/scripts.tar.gz \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/

      - name: Extract scripts in Production
        if: needs.changes.outputs.scripts == 'true' || needs.changes.outputs.overrides == 'true'
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            DEST_PATH="${{ secrets.VPS_PROD_PATH }}"
            DEST_PATH=${DEST_PATH:-/opt/olmeraot/prod}
            cd "$DEST_PATH"
            rm -rf current/data current/data-canary current/data-otservbr-global current/overrides
            tar xzf /tmp/scripts.tar.gz
            ln -sf ../config.lua current/config.lua
            chmod 640 current/key.pem || true
            rm -f /tmp/scripts.tar.gz

      - name: Download qa-latest release assets
        run: |
          # Descargar desde qa-latest (ya probado en QA)
          curl -fsSL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -o olmeraot-linux-x86_64.zip \
            "https://github.com/${{ github.repository }}/releases/download/qa-latest/olmeraot-linux-x86_64.zip"
          
          curl -fsSL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -o SHA256SUMS \
            "https://github.com/${{ github.repository }}/releases/download/qa-latest/SHA256SUMS"

      - name: Verify SHA256
        run: |
          sha256sum -c SHA256SUMS
          echo "‚úÖ SHA256 verification passed"

      - name: Publish prod-latest release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: prod-latest
          name: Production Latest
          body: |
            üéØ **Production Release**
            
            Promoted from `qa-latest` after successful testing.
            
            **Original build:** ${{ github.sha }}
            **Promoted at:** ${{ github.event.head_commit.timestamp }}
            **Branch:** main
            
            ---
            ‚ö†Ô∏è This build was NOT recompiled - promoted from QA for consistency.
          draft: false
          prerelease: false
          files: |
            olmeraot-linux-x86_64.zip
            SHA256SUMS

      - name: Prepare SSH known_hosts (Prod)
        if: vars.PROD_DEPLOY_ENABLED == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          if [ -n "${{ secrets.SSH_KNOWN_HOSTS }}" ]; then
            printf '%s\n' "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true
          fi
          chmod 644 ~/.ssh/known_hosts

      - name: Deploy to Production Server
        if: vars.PROD_DEPLOY_ENABLED == 'true'
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            DEST_PATH="${{ secrets.VPS_PROD_PATH }}"
            DEST_PATH=${DEST_PATH:-/opt/olmeraot/prod}
            cd "$DEST_PATH"
            
            # Backup current version
            if [ -f olmeraot ]; then
              cp olmeraot "olmeraot.backup.$(date +%Y%m%d_%H%M%S)"
            fi
            
            # Download prod-latest
            curl -fsSL -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -o olmeraot.zip \
              "https://github.com/${{ github.repository }}/releases/download/prod-latest/olmeraot-linux-x86_64.zip"
            
            unzip -o olmeraot.zip
            chmod +x olmeraot
            
            # Create symlink for config.lua in current/
            ln -sf ../config.lua current/config.lua
            # Ensure key.pem available in current even if scripts didn't change
            if [ ! -f current/key.pem ] && [ -f key.pem ]; then
              cp -f key.pem current/key.pem
            fi
            chmod 640 current/key.pem || true
            
            # Restart production service
            sudo systemctl restart olmeraot-prod
            
            # Health check
            sleep 5
            sudo systemctl status olmeraot-prod
