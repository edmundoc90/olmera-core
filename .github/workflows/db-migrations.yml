name: Database Migrations

on:
  pull_request:
    paths:
      - 'data/**/migrations/**'
      - 'data-canary/migrations/**'
      - 'data-otservbr-global/migrations/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run migrations against'
        required: true
        default: 'qa'
        type: choice
        options:
          - qa
          - preview
          - staging

env:
  DB_BACKUP_PATH: '/tmp/db_backups'

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      has_migrations: ${{ steps.check.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Check for migration changes
        id: check
        uses: dorny/paths-filter@v2
        with:
          filters: |
            migrations:
              - 'data/**/migrations/**'
              - 'data-canary/migrations/**'
              - 'data-otservbr-global/migrations/**'

  backup:
    needs: prepare
    if: needs.prepare.outputs.has_migrations == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Create backup directory
        run: mkdir -p ${{ env.DB_BACKUP_PATH }}

      - name: Backup database
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          timestamp=$(date +%Y%m%d_%H%M%S)
          backup_file="${{ env.DB_BACKUP_PATH }}/${DB_NAME}_${timestamp}.sql"
          
          # Create backup
          mysqldump -h $DB_HOST -u $DB_USER -p$DB_PASS $DB_NAME > $backup_file
          
          # Compress backup
          gzip $backup_file
          
          # Save backup path for later steps
          echo "BACKUP_FILE=${backup_file}.gz" >> $GITHUB_ENV

      - name: Upload backup artifact
        uses: actions/upload-artifact@v3
        with:
          name: db-backup
          path: ${{ env.BACKUP_FILE }}
          retention-days: 5

  migrate:
    needs: [prepare, backup]
    if: needs.prepare.outputs.has_migrations == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mysql-connector-python

      - name: Run migrations
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          python .github/scripts/run_migrations.py

  verify:
    needs: migrate
    runs-on: ubuntu-latest
    steps:
      - name: Verify database state
        env:
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          mysql -h $DB_HOST -u $DB_USER -p$DB_PASS $DB_NAME -e "
            SELECT 
              schema_version,
              last_migration_date,
              status
            FROM schema_migrations
            ORDER BY last_migration_date DESC
            LIMIT 1;
          "