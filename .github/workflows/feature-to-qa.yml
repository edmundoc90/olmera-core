name: Feature Branch Deploy

on:
  push:
    branches:
      - 'feature/**'
      - 'fix/**'
  workflow_dispatch:

jobs:
  detect-changes:
    if: startsWith(github.ref, 'refs/heads/feature/') || startsWith(github.ref, 'refs/heads/fix/') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    outputs:
      needs_build: ${{ steps.filter.outputs.cxx }}
      needs_sync: ${{ steps.filter.outputs.scripts }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            cxx:
              - 'src/**'
              - 'CMakeLists.txt'
              - 'vcpkg.json'
            scripts:
              - 'data/**/*.lua'
              - 'data/**/*.xml'
              - 'overrides/**'

  backup-qa:
    runs-on: ubuntu-latest
    steps:
      - name: Create QA backup
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            BACKUP_DIR="/backups/olmeraot/qa"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            # Backup current state
            mkdir -p "${BACKUP_DIR}/${TIMESTAMP}"
            systemctl stop olmeraot-qa
            
            # Backup binary and data
            cp -a /opt/olmeraot/qa/bin/olmeraot "${BACKUP_DIR}/${TIMESTAMP}/"
            cp -a /opt/olmeraot/qa/data "${BACKUP_DIR}/${TIMESTAMP}/"
            
            # Backup DB if needed
            # pg_dump ... > "${BACKUP_DIR}/${TIMESTAMP}/db.sql"
            
            # Create latest symlink
            ln -sf "${BACKUP_DIR}/${TIMESTAMP}" "${BACKUP_DIR}/latest"
            
            systemctl start olmeraot-qa

  build-if-needed:
    needs: [detect-changes, backup-qa]
    if: needs.detect-changes.outputs.needs_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # ... pasos de build igual que build-ubuntu.yml ...
      
      - name: Upload binary
        uses: actions/upload-artifact@v3
        with:
          name: olmeraot-feature
          path: dist/olmeraot-linux-x86_64.zip

  deploy-to-qa:
    needs: [detect-changes, build-if-needed]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      
      - name: Download binary if built
        if: needs.detect-changes.outputs.needs_build == 'true'
        uses: actions/download-artifact@v3
        with:
          name: olmeraot-feature
          path: dist
      
      - name: Deploy to QA
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            cd "${{ secrets.VPS_QA_PATH }}"
            
            # Si hay nuevo binario
            if [ -f dist/olmeraot-linux-x86_64.zip ]; then
              unzip -o dist/olmeraot-linux-x86_64.zip -d /opt/olmeraot/qa/bin/
              chmod +x /opt/olmeraot/qa/bin/olmeraot
            fi
            
            # Sync scripts
            if [[ ${{ needs.detect-changes.outputs.needs_sync }} == 'true' ]]; then
              rsync -av --delete data/ /opt/olmeraot/qa/data/
              # Si el server soporta reload de scripts
              # curl -X POST http://localhost:7171/reload_scripts
            fi
            
            # Decide restart vs hot-reload:
            if [ -f dist/olmeraot-linux-x86_64.zip ]; then
              echo "[QA] Binary updated -> restarting service"
              sudo systemctl restart olmeraot-qa.service
            else
              if [[ "${{ needs.detect-changes.outputs.needs_sync }}" == 'true' ]]; then
                echo "[QA] Only scripts/data updated -> sending SIGHUP to trigger hot-reload"
                if command -v systemctl >/dev/null 2>&1; then
                  sudo systemctl kill -s HUP olmeraot-qa.service || true
                else
                  pid=$(pidof olmeraot || true)
                  [ -n "$pid" ] && kill -HUP $pid || true
                fi
              else
                echo "[QA] No updates requiring reload"
              fi
            fi

            # Mostrar estado y logs
            systemctl --no-pager status olmeraot-qa.service
            tail -n 50 /var/log/olmeraot/qa.log

  notify-qa:
    needs: deploy-to-qa
    runs-on: ubuntu-latest
    steps:
      - name: Get branch name
        id: branch
        run: echo "name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT
      
      - name: Notify Discord
        if: ${{ secrets.DISCORD_WEBHOOK }}
        uses: Ilshidur/action-discord@master
        with:
          args: |
            ðŸš€ Nueva feature desplegada en QA
            Branch: ${{ steps.branch.outputs.name }}
            Cambios:
            - Build: ${{ needs.detect-changes.outputs.needs_build == 'true' && 'âœ…' || 'âž–' }}
            - Scripts: ${{ needs.detect-changes.outputs.needs_sync == 'true' && 'âœ…' || 'âž–' }}
            
            Para probar:
            1. Activar feature: `/feature enable ${{ steps.branch.outputs.name }}`
            2. Desactivar: `/feature disable ${{ steps.branch.outputs.name }}`
            3. Si hay problemas: `/backup restore`