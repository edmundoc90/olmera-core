name: Build on VPS (Self-Hosted)

on:
  push:
    branches: [ develop ]
    paths:
      - 'src/**'
      - 'tests/**/*.cpp'
      - 'cmake/**'
      - 'CMakeLists.txt'
      - 'vcpkg.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: ubuntu-22.04-linux-release (VPS)
    runs-on: [self-hosted, linux, X64, olmera-vps]
    env:
      CMAKE_BUILD_PARALLEL_LEVEL: 4
      MAKEFLAGS: "-j 4"
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure prereqs exist (gcc, g++, unzip)
        run: |
          set -e
          if ! command -v gcc >/dev/null 2>&1; then
            sudo apt-get update -y && sudo apt-get install -y build-essential
          fi
          if ! command -v unzip >/dev/null 2>&1; then
            sudo apt-get update -y && sudo apt-get install -y unzip
          fi

      - name: CCache (speed up recompiles)
        uses: hendrikmuhs/ccache-action@main
        with:
          max-size: "5G"
          key: ccache-selfhosted-ubuntu2204-linux-release

      - name: Resolve vcpkg baseline
        id: vcpkg-step
        run: |
          vcpkgCommitId=$(grep '.builtin-baseline' vcpkg.json | awk -F: '{print $2}' | tr -d '," ')
          echo "VCPKG_GIT_COMMIT_ID=$vcpkgCommitId" >> "$GITHUB_ENV"

      - name: Get vcpkg
        uses: lukka/run-vcpkg@main
        with:
          vcpkgGitURL: "https://github.com/microsoft/vcpkg.git"
          vcpkgGitCommitId: ${{ env.VCPKG_GIT_COMMIT_ID }}

      - name: Get latest CMake and ninja
        uses: lukka/get-cmake@main

      - name: Configure & Build (linux-release)
        uses: lukka/run-cmake@main
        with:
          configurePresetAdditionalArgs: "['-DTOGGLE_BIN_FOLDER=ON']"
          configurePreset: linux-release
          buildPreset: linux-release

      - name: Package binary (zip + sha256)
        run: |
          mkdir -p dist
          cp build/linux-release/bin/olmeraot dist/olmeraot
          cd dist
          zip -r olmeraot-linux-x86_64.zip olmeraot
          sha256sum olmeraot-linux-x86_64.zip > SHA256SUMS
          ls -l

      - name: Publish QA latest (qa-latest)
        uses: softprops/action-gh-release@v2
        if: github.ref == 'refs/heads/develop'
        with:
          tag_name: qa-latest
          name: QA Latest
          body: "Auto-updated from develop (${{ github.sha }}) via self-hosted runner."
          draft: false
          prerelease: true
          files: |
            dist/olmeraot-linux-x86_64.zip
            dist/SHA256SUMS
