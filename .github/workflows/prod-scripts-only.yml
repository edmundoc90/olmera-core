name: "Stage 5A: Sync Scripts to Production (Main Only)"

on:
  push:
    branches: [ main ]

permissions:
  contents: read

jobs:
  changes:
    name: Detect Changes (scripts/overrides)
    runs-on: ubuntu-latest
    outputs:
      scripts: ${{ steps.filter.outputs.scripts }}
      overrides: ${{ steps.filter.outputs.overrides }}
      cpp: ${{ steps.filter.outputs.cpp }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          filters: |
            scripts:
              - 'data/**'
              - 'data-canary/**'
              - 'data-otservbr-global/**'
            overrides:
              - 'overrides'
              - 'overrides/**'
            cpp:
              - 'src/**'
              - 'cmake/**'
              - 'CMakeLists.txt'
              - 'vcpkg.json'

  sync-scripts-prod:
    name: "Stage 5A: Sync Scripts to Production"
    needs: changes
    if: |
      (needs.changes.outputs.scripts == 'true' || needs.changes.outputs.overrides == 'true') &&
      needs.changes.outputs.cpp != 'true'
    runs-on: ubuntu-latest
    environment:
      name: production-server
      url: https://olmeraot.com
    env:
      PROD_DEPLOY_ENABLED: ${{ vars.PROD_DEPLOY_ENABLED || secrets.PROD_DEPLOY_ENABLED }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          token: ${{ secrets.GH_PAT || github.token }}

      - name: Prepare SSH known_hosts (Prod)
        if: env.PROD_DEPLOY_ENABLED == 'true'
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          if [ -n "${{ secrets.SSH_KNOWN_HOSTS }}" ]; then
            printf '%s\n' "${{ secrets.SSH_KNOWN_HOSTS }}" >> ~/.ssh/known_hosts
          else
            ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true
          fi
          chmod 644 ~/.ssh/known_hosts

      - name: Upload scripts to Production (tar + SSH)
        if: env.PROD_DEPLOY_ENABLED == 'true'
        run: |
          set -euo pipefail
          
          # Crear tarball con prefijo current/ usando transform
          tar czf /tmp/scripts.tar.gz \
            --transform 's,^,current/,' \
            data data-canary data-otservbr-global overrides key.pem
          
          # Transferir a producción
          scp -o StrictHostKeyChecking=yes \
            -i <(echo "${{ secrets.SSH_PRIVATE_KEY }}") \
            /tmp/scripts.tar.gz \
            ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/tmp/

      - name: Extract and reload (SIGHUP)
        if: env.PROD_DEPLOY_ENABLED == 'true'
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            DEST_PATH="${{ secrets.VPS_PROD_PATH }}"
            DEST_PATH=${DEST_PATH:-/opt/olmeraot/prod}
            
            cd "$DEST_PATH"
            
            # Limpiar directorios actuales antes de extraer
            rm -rf current/data current/data-canary current/data-otservbr-global current/overrides
            
            # Extraer directamente en el path padre
            tar xzf /tmp/scripts.tar.gz
            
            # Create symlink for config.lua en current/
            ln -sf ../config.lua current/config.lua
            # Asegurar permisos de key.pem
            chmod 640 current/key.pem || true
            
            # Hot-reload con SIGHUP
            pkill -SIGHUP olmeraot || echo "Server not running or signal failed"
            
            echo "✅ Scripts synced to production and server reloaded"

      - name: Comment on commit
        if: env.PROD_DEPLOY_ENABLED == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: context.sha,
              body: `✅ Synced scripts/overrides to Production (scripts-only path)`
            });
