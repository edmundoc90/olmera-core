name: Build on VPS via SSH

on:
  push:
    branches: [ develop ]
    paths:
      - 'src/**'
      - 'tests/**/*.cpp'
      - 'cmake/**'
      - 'CMakeLists.txt'
      - 'vcpkg.json'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-release:
    name: ubuntu-22.04-linux-release (VPS-SSH)
    runs-on: ubuntu-latest
    steps:
      - name: Compute metadata
        id: meta
        run: |
          echo "sha_short=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "repo=${GITHUB_REPOSITORY}" >> $GITHUB_OUTPUT

      - name: Prepare VPS workspace and build
        uses: appleboy/ssh-action@v1.2.0
        env:
          REPO: ${{ steps.meta.outputs.repo }}
          SHA: ${{ github.sha }}
        with:
          host: ${{ secrets.BUILD_SSH_HOST }}
          username: ${{ secrets.BUILD_SSH_USER }}
          key: ${{ secrets.BUILD_SSH_KEY }}
          envs: REPO,SHA
          command_timeout: 60m
          script_stop: true
          script: |
            set -euo pipefail
            BASE_DIR=~/builds/olmera
            WORKDIR=$BASE_DIR/${SHA}
            mkdir -p "$WORKDIR"
            cd "$WORKDIR"

            # Get source snapshot (public tarball by commit SHA)
            if [ ! -d src ]; then
              curl -fsSL -o src.tar.gz "https://codeload.github.com/${REPO}/tar.gz/${SHA}"
              tar -xzf src.tar.gz --strip-components=1
              rm -f src.tar.gz
            fi

            # vcpkg bootstrap (cached under ~/vcpkg)
            VCPKG_ROOT=~/vcpkg
            if [ ! -d "$VCPKG_ROOT" ]; then
              git clone https://github.com/microsoft/vcpkg.git "$VCPKG_ROOT"
              "$VCPKG_ROOT"/bootstrap-vcpkg.sh
            fi
            export VCPKG_ROOT

            # Configure and build (linux-release)
            cd "$WORKDIR"
            cmake -S . -B build/linux-release -G Ninja \
              -DCMAKE_BUILD_TYPE=Release \
              -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
              -DTOGGLE_BIN_FOLDER=ON \
              -DSPEED_UP_BUILD_UNITY=OFF
            cmake --build build/linux-release --config Release -j $(nproc)

            # Package artifacts
            mkdir -p dist
            cp build/linux-release/bin/olmeraot dist/olmeraot
            (cd dist && zip -r olmeraot-linux-x86_64.zip olmeraot && sha256sum olmeraot-linux-x86_64.zip > SHA256SUMS)

      - name: Publish qa-latest from VPS
        uses: appleboy/ssh-action@v1.2.0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ steps.meta.outputs.repo }}
          SHA: ${{ github.sha }}
        with:
          host: ${{ secrets.BUILD_SSH_HOST }}
          username: ${{ secrets.BUILD_SSH_USER }}
          key: ${{ secrets.BUILD_SSH_KEY }}
          envs: GH_TOKEN,REPO,SHA
          script_stop: true
          script: |
            set -euo pipefail
            BASE_DIR=~/builds/olmera
            WORKDIR=$BASE_DIR/${SHA}
            cd "$WORKDIR"

            # Install GitHub CLI if missing
            if ! command -v gh >/dev/null 2>&1; then
              echo "Error: gh CLI not found. Please install it on the VPS."
              exit 1
            fi

            cd dist
            # Create or update qa-latest release (prerelease) and upload assets
            if gh release view qa-latest -R "$REPO" >/dev/null 2>&1; then
              gh release upload qa-latest olmeraot-linux-x86_64.zip SHA256SUMS -R "$REPO" --clobber
            else
              gh release create qa-latest olmeraot-linux-x86_64.zip SHA256SUMS -R "$REPO" \
                --title "QA Latest" \
                --notes "Auto-updated from develop ($SHA) via VPS build." \
                --prerelease
            fi
