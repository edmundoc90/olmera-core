name: PR Preview Environment

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      needs_build: ${{ steps.filter.outputs.cxx }}
      needs_sync: ${{ steps.filter.outputs.scripts }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            cxx:
              - 'src/**'
              - 'CMakeLists.txt'
              - 'vcpkg.json'
            scripts:
              - 'data/**/*.lua'
              - 'data/**/*.xml'
              - 'overrides/**'

  build-if-needed:
    needs: detect-changes
    if: needs.detect-changes.outputs.needs_build == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      # Usar los mismos pasos de build que build-ubuntu.yml
      # pero guardando el binario como artifact para el deploy
      - name: Build binary
        run: |
          # ... pasos de build ...
          mkdir -p artifacts
          cp build/linux-release/bin/olmeraot artifacts/
      
      - uses: actions/upload-artifact@v3
        with:
          name: olmeraot-pr-${{ github.event.pull_request.number }}
          path: artifacts/olmeraot

  deploy-preview:
    needs: [detect-changes, build-if-needed]
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    env:
      PR_NUMBER: ${{ github.event.pull_request.number }}
      PREVIEW_PORT: ${{ 7171 + github.event.pull_request.number }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      
      # Si hubo build, descargar el artifact
      - if: needs.detect-changes.outputs.needs_build == 'true'
        uses: actions/download-artifact@v3
        with:
          name: olmeraot-pr-${{ github.event.pull_request.number }}
          path: artifacts
      
      - name: Deploy to VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: PR_NUMBER,PREVIEW_PORT
          script: |
            set -euo pipefail
            
            # Preparar directorios
            PREVIEW_DIR="/data/olmeraot/pr-${PR_NUMBER}"
            LOG_DIR="/var/log/olmeraot/pr-${PR_NUMBER}"
            mkdir -p "${PREVIEW_DIR}" "${LOG_DIR}"
            
            # Detener container existente si existe
            docker rm -f "olmeraot-pr-${PR_NUMBER}" || true
            
            # Si hay binario nuevo, copiarlo
            if [ -f artifacts/olmeraot ]; then
              cp artifacts/olmeraot "${PREVIEW_DIR}/"
              chmod +x "${PREVIEW_DIR}/olmeraot"
            fi
            
            # Sync archivos del repo
            rsync -av --delete data/ "${PREVIEW_DIR}/data/"
            rsync -av --delete overrides/ "${PREVIEW_DIR}/overrides/"
            
            # Generar config especÃ­fica para el preview
            cat > "${PREVIEW_DIR}/config.lua" <<EOF
            -- Config para PR #${PR_NUMBER}
            serverName = "Preview PR-${PR_NUMBER}"
            loginPort = ${PREVIEW_PORT}
            statusPort = $((PREVIEW_PORT + 1))
            dataFolder = "${PREVIEW_DIR}/data"
            logsFolder = "${LOG_DIR}"
            EOF
            
            # Crear y arrancar container
            docker run -d \
              --name "olmeraot-pr-${PR_NUMBER}" \
              -p "${PREVIEW_PORT}:7171" \
              -v "${PREVIEW_DIR}:/app" \
              -v "${LOG_DIR}:/app/logs" \
              olmeraot:latest
            
            echo "Preview desplegado en puerto ${PREVIEW_PORT}"
            echo "Logs en ${LOG_DIR}"

  cleanup-preview:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    env:
      PR_NUMBER: ${{ github.event.pull_request.number }}
    steps:
      - name: Cleanup on VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: PR_NUMBER
          script: |
            set -euo pipefail
            
            # Detener y eliminar container
            docker rm -f "olmeraot-pr-${PR_NUMBER}" || true
            
            # Backup logs (opcional)
            LOG_DIR="/var/log/olmeraot/pr-${PR_NUMBER}"
            if [ -d "${LOG_DIR}" ]; then
              tar czf "${LOG_DIR}.tar.gz" "${LOG_DIR}"
            fi
            
            # Limpiar directorios
            rm -rf "/data/olmeraot/pr-${PR_NUMBER}" "${LOG_DIR}"